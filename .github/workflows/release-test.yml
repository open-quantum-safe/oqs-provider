name: Release tests

permissions:
  contents: read

on:
  workflow_call:
    inputs:
      liboqs_ref:
        description: 'liboqs branch or tag'
        required: true
        default: 'main'
        type: string
      provider_ref:
        description: 'oqs-provider branch or tag'
        required: true
        default: 'main'
        type: string
  workflow_dispatch:
    inputs:
      liboqs_ref:
        description: 'liboqs branch or tag'
        required: true
        default: 'main'
        type: string
      provider_ref:
        description: 'oqs-provider branch or tag'
        required: true
        default: 'main'
        type: string

jobs:
  release-test:
    runs-on: ubuntu-latest
    container:
      image: openquantumsafe/ci-ubuntu-jammy:latest

    steps:
      - name: Check if requested oqs-provider ref exists
        env:
          provider_ref: ${{ inputs.provider_ref }}
        run: |
          # try both branch and tag
          wget --quiet \
               --header "Accept: application/vnd.github+json" \
               --header "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
               --header "X-GitHub-Api-Version: 2022-11-28" \
               https://api.github.com/repos/open-quantum-safe/oqs-provider/branches/$provider_ref || \
          wget --quiet \
               --header "Accept: application/vnd.github+json" \
               --header "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
               --header "X-GitHub-Api-Version: 2022-11-28" \
               https://api.github.com/repos/open-quantum-safe/oqs-provider/git/ref/tags/$provider_ref \
            && echo "provider_ref=$provider_ref" >> "$GITHUB_ENV" \
            || echo "provider_ref=main" >> "$GITHUB_ENV"
      - name: Check if requested liboqs ref exists
        env:
          provider_ref: ${{ inputs.liboqs_ref }}
        run: |
          # try both branch and tag
          wget --quiet \
               --header "Accept: application/vnd.github+json" \
               --header "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
               --header "X-GitHub-Api-Version: 2022-11-28" \
               https://api.github.com/repos/open-quantum-safe/liboqs/branches/$liboqs_ref || \
          wget --quiet \
               --header "Accept: application/vnd.github+json" \
               --header "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
               --header "X-GitHub-Api-Version: 2022-11-28" \
               https://api.github.com/repos/open-quantum-safe/liboqs/git/ref/tags/$liboqs_ref \
            && echo "liboqs_ref=$liboqs_ref" >> "$GITHUB_ENV" \
            || echo "liboqs_ref=main" >> "$GITHUB_ENV"
      - name: Checkout oqs-provider on requested ref if it exists; otherwise, fall back to main
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # pin@v4
        with:
          ref: ${{ env.provider_ref }}
      - name: Checkout liboqs at requested ref if it exists; otherwise, fall back to main
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # pin@v4
        with:
          repository: open-quantum-safe/liboqs
          path: liboqs
          ref: ${{ env.liboqs_ref }}
      - name: Run release tests
        run: OPENSSL_BRANCH=master ./scripts/release-test-ci.sh
